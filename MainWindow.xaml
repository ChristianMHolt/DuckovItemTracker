<Window x:Class="ItemTracker.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ItemTracker"
        xmlns:conv="clr-namespace:ItemTracker.Utilities"
        mc:Ignorable="d"
        Title="Game Item Price Tracker"
        Height="680"
        Width="1100"
        Icon="duck.ico"
        MinWidth="900"
        MinHeight="560"
        Background="Transparent"
        AllowsTransparency="False">
    <Window.CommandBindings>
        <CommandBinding Command="{x:Static local:MainWindow.AddOrUpdateCommand}"
                        Executed="OnAddOrUpdateCommandExecuted"
                        CanExecute="OnAddOrUpdateCommandCanExecute" />
        <CommandBinding Command="{x:Static local:MainWindow.FocusSearchCommand}"
                        Executed="OnFocusSearchExecuted" />
        <CommandBinding Command="{x:Static local:MainWindow.ClearSearchCommand}"
                        Executed="OnClearSearchExecuted" />
    </Window.CommandBindings>
    <Window.InputBindings>
        <KeyBinding Key="S" Modifiers="Control" Command="{x:Static local:MainWindow.AddOrUpdateCommand}" />
        <KeyBinding Key="S" Modifiers="Alt" Command="{x:Static local:MainWindow.FocusSearchCommand}" />
        <KeyBinding Key="C" Modifiers="Alt" Command="{x:Static local:MainWindow.ClearSearchCommand}" />
    </Window.InputBindings>
    <Window.Resources>
        <DropShadowEffect x:Key="SoftShadow" BlurRadius="12" ShadowDepth="2" Direction="270" Opacity="0.35" Color="#000000" />

        <LinearGradientBrush x:Key="WindowBackground" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#0E1526" Offset="0" />
            <GradientStop Color="#0B172F" Offset="1" />
        </LinearGradientBrush>

        <SolidColorBrush x:Key="CardBackground" Color="#101A2D" />
        <SolidColorBrush x:Key="CardSecondary" Color="#0C1423" />
        <SolidColorBrush x:Key="AccentBrush" Color="#5FD7FF" />
        <SolidColorBrush x:Key="AccentBrushDeep" Color="#35B4E6" />
        <SolidColorBrush x:Key="SubtleBrush" Color="#8CA5C1" />
        <SolidColorBrush x:Key="InputBackground" Color="#162337" />
        <SolidColorBrush x:Key="BorderBrush" Color="#21324B" />
        <SolidColorBrush x:Key="HeaderTextBrush" Color="#E6ECF5" />
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />

        <Style TargetType="GroupBox">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Margin" Value="0,0,0,0" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupBox">
                        <Border Background="{StaticResource CardBackground}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1" CornerRadius="10" Padding="12" Effect="{StaticResource SoftShadow}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>
                                <Border Background="{StaticResource CardSecondary}" Padding="4,6" CornerRadius="6" Grid.Row="0">
                                    <TextBlock Text="{TemplateBinding Header}" FontWeight="Bold" Foreground="{StaticResource AccentBrush}" />
                                </Border>
                                <ContentPresenter Grid.Row="1" />
                            </Grid>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="TextOptions.TextFormattingMode" Value="Ideal" />
            <Setter Property="TextOptions.TextRenderingMode" Value="Auto" />
            <Setter Property="FontFamily" Value="Segoe UI" />
        </Style>

        <Style TargetType="TextBox">
            <Setter Property="Background" Value="{StaticResource InputBackground}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="FontFamily" Value="Segoe UI" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
        </Style>

        <Style TargetType="ComboBox">
            <Setter Property="Background" Value="{StaticResource AccentBrush}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}" />
            <Setter Property="Padding" Value="10,6" />
            <Setter Property="FontFamily" Value="Segoe UI" />
            <Setter Property="SnapsToDevicePixels" Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton x:Name="ToggleButton"
                                          Background="{TemplateBinding Background}"
                                          BorderBrush="{TemplateBinding BorderBrush}"
                                          BorderThickness="{TemplateBinding BorderThickness}"
                                          Focusable="False"
                                          IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                          ClickMode="Press"
                                          SnapsToDevicePixels="True">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border x:Name="Border"
                                                CornerRadius="8"
                                                Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}">
                                            <Grid>
                                                <ContentPresenter x:Name="ContentSite"
                                                                  Margin="6,0,28,0"
                                                                  IsHitTestVisible="False"
                                                                  HorizontalAlignment="Left"
                                                                  VerticalAlignment="Center"
                                                                  Content="{TemplateBinding Content}"
                                                                  ContentTemplate="{TemplateBinding ContentTemplate}"
                                                                  ContentTemplateSelector="{TemplateBinding ContentTemplateSelector}" />
                                                <Path x:Name="Arrow"
                                                      HorizontalAlignment="Right"
                                                      VerticalAlignment="Center"
                                                      Margin="0,0,10,0"
                                                      Fill="White"
                                                      Data="M 0 0 L 6 6 L 12 0 Z" />
                                            </Grid>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="{StaticResource AccentBrushDeep}" />
                                                <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource AccentBrushDeep}" />
                                            </Trigger>
                                            <Trigger Property="IsKeyboardFocused" Value="True">
                                                <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource AccentBrushDeep}" />
                                            </Trigger>
                                            <Trigger Property="IsChecked" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="{StaticResource AccentBrushDeep}" />
                                                <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource AccentBrushDeep}" />
                                            </Trigger>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter Property="Opacity" Value="0.6" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                                <ToggleButton.Content>
                                    <ContentPresenter Content="{TemplateBinding SelectionBoxItem}"
                                                      ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                                      ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}" />
                                </ToggleButton.Content>
                            </ToggleButton>
                            <Popup x:Name="PART_Popup"
                                   Placement="Bottom"
                                   AllowsTransparency="True"
                                   Focusable="False"
                                   IsOpen="{TemplateBinding IsDropDownOpen}"
                                   PopupAnimation="Slide">
                                <Border x:Name="DropDownBorder"
                                        Background="{StaticResource CardSecondary}"
                                        BorderBrush="{StaticResource BorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        MinWidth="{TemplateBinding ActualWidth}"
                                        Effect="{StaticResource SoftShadow}">
                                    <ScrollViewer Margin="0,4" SnapsToDevicePixels="True">
                                        <ItemsPresenter />
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Background" Value="{StaticResource AccentBrush}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource AccentBrushDeep}" />
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource AccentBrushDeep}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="Button">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Background" Value="{StaticResource AccentBrush}" />
            <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontFamily" Value="Segoe UI" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="8" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="1">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="SnapsToDevicePixels" Value="True" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource AccentBrushDeep}" />
                    <Setter Property="BorderBrush" Value="{StaticResource AccentBrushDeep}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="{StaticResource CardBackground}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
            <Setter Property="RowBackground" Value="#132036" />
            <Setter Property="AlternatingRowBackground" Value="#0E1728" />
            <Setter Property="HorizontalGridLinesBrush" Value="#20314E" />
            <Setter Property="VerticalGridLinesBrush" Value="#20314E" />
            <Setter Property="Padding" Value="6" />
            <Setter Property="Effect" Value="{StaticResource SoftShadow}" />
        </Style>

        <Style TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="#12253B" />
            <Setter Property="Foreground" Value="#E6ECF5" />
            <Setter Property="BorderBrush" Value="#1D3553" />
            <Setter Property="BorderThickness" Value="0,0,1,1" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>

        <Style TargetType="StatusBar">
            <Setter Property="Background" Value="#0A1220" />
            <Setter Property="Foreground" Value="{StaticResource SubtleBrush}" />
            <Setter Property="Padding" Value="10,4" />
        </Style>

        <conv:IconPathToImageSourceConverter x:Key="IconConverter" />
    </Window.Resources>
    <Grid Background="{StaticResource WindowBackground}">
        <Grid Margin="18">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Border Grid.RowSpan="5" CornerRadius="18" Background="#0B1322" BorderBrush="#1A2942" BorderThickness="1" Padding="14" Effect="{StaticResource SoftShadow}" />

            <Border Grid.Row="0" Padding="12" CornerRadius="12" Background="#111C2F" BorderBrush="#1E3049" BorderThickness="1" Effect="{StaticResource SoftShadow}">
                <DockPanel>
                    <Grid Width="46" Height="46" Margin="0,0,12,0">
                        <Ellipse Fill="{StaticResource AccentBrush}" />
                        <TextBlock Text="ðŸŽ¯" FontSize="20" HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Grid>
                    <StackPanel>
                        <TextBlock Text="Track, price, and verify your game items" FontSize="24" FontWeight="SemiBold" Foreground="{StaticResource HeaderTextBrush}" />
                        <TextBlock Text="Organize every drop with clean pricing, fast search, and instant verification." Foreground="{StaticResource SubtleBrush}" Margin="0,4,0,0" />
                    </StackPanel>
                </DockPanel>
            </Border>

            <!-- Form and totals -->
            <DockPanel Grid.Row="1" Margin="0,12,0,0" LastChildFill="True">
                <StackPanel Orientation="Vertical" DockPanel.Dock="Right" Width="220" Margin="14,0,0,0" VerticalAlignment="Top">
                    <TextBlock Text="Collection health" FontWeight="Bold" Foreground="{StaticResource SubtleBrush}" />
                    <Border Width="220" Background="{StaticResource CardBackground}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1" CornerRadius="12" Padding="12" Margin="0,6,0,0" Effect="{StaticResource SoftShadow}">
                        <TextBlock Text="{Binding TotalsText}" TextWrapping="Wrap" />
                    </Border>
                    <Button Content="Verify" Width="220" Margin="0,12,0,0" Click="OnVerifyClick" />
                </StackPanel>

                <GroupBox Header="Item Details" Padding="12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="150" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="140" />
                            <ColumnDefinition Width="150" />
                            <ColumnDefinition Width="150" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Name" VerticalAlignment="Center" />
                        <StackPanel Grid.Row="0" Grid.Column="1" Margin="6,0">
                            <TextBox x:Name="NameTextBox"
                                     Text="{Binding NameText, UpdateSourceTrigger=PropertyChanged}"
                                     PreviewKeyDown="OnNameTextBoxPreviewKeyDown" />
                            <ListBox x:Name="NameSuggestionsListBox"
                                     Margin="0,4,0,0"
                                     ItemsSource="{Binding FilteredNameSuggestions}"
                                     Visibility="{Binding IsNameSuggestionVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                                     MaxHeight="160"
                                     Background="{StaticResource CardSecondary}"
                                     BorderBrush="{StaticResource BorderBrush}"
                                     Foreground="White"
                                     PreviewMouseLeftButtonUp="OnNameSuggestionClicked"
                                     PreviewKeyDown="OnNameSuggestionKeyDown" />
                        </StackPanel>

                        <TextBlock Grid.Row="0" Grid.Column="2" Text="Unit Price" VerticalAlignment="Center" />
                        <TextBox Grid.Row="0" Grid.Column="3" Margin="6,0" Width="140" Text="{Binding UnitPriceText}" />

                        <TextBlock Grid.Row="0" Grid.Column="4" Text="Stack Size" VerticalAlignment="Center" />
                        <TextBox x:Name="StackSizeTextBox"
                                 Grid.Row="0"
                                 Grid.Column="4"
                                 Margin="74,0,0,0"
                                 Width="90"
                                 Text="{Binding StackSizeText}"
                                 HorizontalAlignment="Left"
                                 GotKeyboardFocus="OnStackSizeTextBoxGotKeyboardFocus"
                                 PreviewMouseLeftButtonDown="OnStackSizeTextBoxPreviewMouseLeftButtonDown" />

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Durability" VerticalAlignment="Center" />
                        <TextBox Grid.Row="1" Grid.Column="1" Margin="6,6,6,0" Text="{Binding DurabilityText, UpdateSourceTrigger=PropertyChanged}" />

                        <TextBlock Grid.Row="1" Grid.Column="2" Text="Max Durability" VerticalAlignment="Center" />
                        <TextBox Grid.Row="1" Grid.Column="3" Margin="6,6,6,0" Width="140" Text="{Binding MaxDurabilityText, UpdateSourceTrigger=PropertyChanged}" />

                        <TextBlock Grid.Row="1" Grid.Column="4" Margin="0,6,0,0" VerticalAlignment="Center" Foreground="{StaticResource SubtleBrush}" Text="{Binding DurabilityPercentText}" />

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Weight per item (kg)" VerticalAlignment="Center" />
                        <TextBox x:Name="WeightTextBox" Grid.Row="2" Grid.Column="1" Margin="6,6,6,0" Width="180" Text="{Binding WeightText}" GotKeyboardFocus="OnWeightTextBoxGotKeyboardFocus" PreviewMouseLeftButtonDown="OnWeightTextBoxPreviewMouseLeftButtonDown" />
                        <TextBlock Grid.Row="2" Grid.Column="2" Grid.ColumnSpan="3" Margin="6,6,0,0" VerticalAlignment="Center" Foreground="{StaticResource SubtleBrush}" Text="{Binding NameAvailabilityText}" />

                        <StackPanel Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="5" Orientation="Horizontal" Margin="0,18,0,0" HorizontalAlignment="Left">
                            <Button Content="Choose Icon" Width="140" Margin="0,0,10,0" Click="OnChooseIcon" />
                            <TextBlock Text="{Binding IconLabel}" VerticalAlignment="Center" Foreground="{StaticResource SubtleBrush}" Margin="0,0,12,0" />
                            <Button Content="{Binding AddOrUpdateButtonText}" Width="140" Background="#4CAF50" BorderBrush="#4CAF50" Click="OnAddOrUpdate" />
                            <Button Content="Clear Form" Width="130" Margin="10,0,0,0" Background="#23334D" BorderBrush="#23334D" Click="OnClear" />
                            <Button Content="Delete Selected" Width="150" Margin="10,0,0,0" Background="#F44336" BorderBrush="#F44336" Click="OnDelete" />
                        </StackPanel>
                    </Grid>
                </GroupBox>
            </DockPanel>

            <!-- Sorting and search -->
            <Grid Grid.Row="2" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <GroupBox Header="Sorting" Padding="12" Margin="0,0,12,0">
                    <StackPanel Orientation="Vertical" VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Sort by:" VerticalAlignment="Center" />
                            <ComboBox Width="180"
                                      Margin="6,0,0,0"
                                      ItemsSource="{Binding SortFields}"
                                      SelectedItem="{Binding SelectedSortField}" />
                            <TextBlock Text="Order:" Margin="12,0,0,0" VerticalAlignment="Center" />
                            <ComboBox Width="140"
                                      Margin="6,0,0,0"
                                      ItemsSource="{Binding SortOrders}"
                                      SelectedItem="{Binding SelectedSortOrder}" />
                            <Button Content="Apply Sort" Width="120" Margin="14,0,0,0" Click="OnApplySort" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,6,0,0">
                            <TextBlock Text="Durability range:" VerticalAlignment="Center" />
                            <ComboBox Width="180"
                                      Margin="10,0,0,0"
                                      ItemsSource="{Binding DurabilityRanges}"
                                      SelectedItem="{Binding SelectedDurabilityRange}" />
                        </StackPanel>
                    </StackPanel>
                </GroupBox>

                <GroupBox Grid.Column="1" Header="Search" Padding="12">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Search items:" VerticalAlignment="Center" />
                        <TextBox x:Name="SearchTextBox" Width="240" Margin="6,0,0,0" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" />
                        <Button Content="Clear Search" Margin="8,0,0,0" Click="OnClearSearch" />
                    </StackPanel>
                </GroupBox>
            </Grid>

        <!-- Data grid -->
        <DataGrid Grid.Row="3"
                  ItemsSource="{Binding FilteredItems}"
                  SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                  AutoGenerateColumns="False"
                  Margin="0,8,0,8"
                  RowHeight="40"
                  CanUserAddRows="False"
                  IsReadOnly="True">
            <DataGrid.Columns>
                <DataGridTemplateColumn Header="Icon" Width="60">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Image Width="32" Height="32" Stretch="Uniform" Source="{Binding IconPath, Converter={StaticResource IconConverter}}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Item" Binding="{Binding Name}" Width="*" />
                <DataGridTextColumn Header="Unit Price" Binding="{Binding UnitPrice, StringFormat=F2}" Width="100" />
                <DataGridTextColumn Header="Stack Size" Binding="{Binding StackSize}" Width="90" />
                <DataGridTextColumn Header="Price/Stack" Binding="{Binding PricePerStack, StringFormat=F2}" Width="110" />
                <DataGridTextColumn Header="Weight/Item (kg)" Binding="{Binding WeightPerItem, StringFormat=F3}" Width="140" />
                <DataGridTextColumn Header="Price/kg" Binding="{Binding PricePerKg, StringFormat=F2}" Width="100" />
            </DataGrid.Columns>
        </DataGrid>

        <!-- Status -->
        <StatusBar Grid.Row="4">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusText}" />
            </StatusBarItem>
        </StatusBar>
        </Grid>
    </Grid>
</Window>
